#labels Phase-Design
= Overview =

System logger performs logging of system events such as various errors, connection attempts and failures etc. It has nothing with group-chat / private-chat logging, though it may be used for logging system xmpp messages (e.g. error auth messages). 

System log can be configured through [BotConfig system configuration] 

System logs are stored inside local database (SQLite). Log records life time depends on several options:

 * *Store system log for specified number of sessions.*

 When bot is launched, we assume that new session is started. User can specify number of sessions to be logged in system configuration.

 * *Store system log records for specified time period*

 If bot is running permanently, user can specify interval of storing system logs. If log record will be older then logging interval it will be cleaned up automatically.

 * *Store only specified ammount of system log records*

 Only latest records will be present in system log. Total count of them is specified in system configuration _Link needed_

 * *Combination of all methods*

 System log cleans up old records and stores logs for only specified number of sessions. Additionally only specified number of system log records will be stored.

= Use-case =

http://jxmpp-bot.googlecode.com/svn/trunk/jxmpp-bot/wiki_images/Syslog%20Use-Case.png

= Data model =

http://jxmpp-bot.googlecode.com/svn/trunk/jxmpp-bot/wiki_images/Syslog%20database.png

= Implementation =

== Creating new log messages ==

Syslog is active object. In predefined intervals (through system configuration) it initiates log cleaning activity. Interval mustn't be too small due to performance issues.
By default log cleaning interval is 10 minutes. This means that each 10 minutes syslog checks if there are any _old_ log messages which should be cleaned from database and memory (if they are cached)

Syslog makes decision whether the record is old or not by the use of _selected strategy of cleaning_. 

During initialization syslog caches multiple database tables into memory:

 # syslog_cathegories
 # sessions
 # syslog_types
 # syslog_senders

Those are "primitives" which will be uses very often in the process of construction of new log messages, so we need to cache them in memory. Also we need a fast thread-safe method which will return current session.

Typically we will use such a process of construction of log message (_*Listing 1*_):

{{{
 Session currentSession = Syslog.getCurrentSession();

 SysLogMessageCathegory cath = new SysLogMessageCathegory("new cathegory");
 SysLogMessageType tp = new SysLogMessageType("new type");
 SysLogSender sndr = new SysLogSender("bot");
 
 SysLogMessage msg = new SysLogMessage("this is new message", currentSession, cath, tp, sndr);
  
 Syslog.putMessage(msg);
}}}

In the first example we create new cathegory, type and sender of Syslog message and attach them to message itself using it's constructor. Those records will be marked as non-persistent and Syslog will take care of inserting them into corresponding tables. Syslog will also cache them in memory in order to reuse them for new log messages.


We can use more user-friendly syntax (_*Listing 2*_):

{{{
 SysLogMessage msg = new SysLogMessage("this is next message. 
     current session will be assigned to it automatically", "test cathegory", "test type", "test sender");
 
 Syslog.putMessage(msg);
}}}

In the second example session's information will be assigned to message automatically (current session will be used) by Syslog. Syslog also will take care of all database routines about creating and caching new cathegory, sender, type. Or if they are already present in database Syslog will retrieve them from cache by text name and assign to LogMessage.

In all methods above you don't need to specify message's timestamp since it will be generated automatically in constructor of message. Timestamp will be set according to current system time.

== Retrieve messages from syslog ==

Syslog provides several methods of retrieving messages from database. Consumer of Syslog can specify folowing retrieval conditions:

 # Date interval (e.g. startDate, endDate)
 # Session(s)
 # Message type(s)
 # Message cathegory(s)
 # Message sender(s)

Syslog will retrieve records from database model (also it reuses cached records) using those conditions. Optionally syslog provides general methods:

{{{
  getMessages(startDate, endDate, sessions, types, cathegories, senders)

  getMessages(startDate, endDate, session, type, cathegory, sender)
}}}

Consumer can pass null to those methods instead of any parameter(s).
For example if consumer will pass null instead of valid cathegory, Syslog will retrieve messages that can have any cathegory. 


= List of reserved syslog cathegories =

_in progress_

= List of reserved syslog types =

_in progress_

= List of reserved syslog senders =

_in progress_